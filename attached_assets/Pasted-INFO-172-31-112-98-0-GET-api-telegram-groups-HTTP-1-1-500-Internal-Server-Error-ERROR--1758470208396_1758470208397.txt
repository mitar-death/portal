INFO:     172.31.112.98:0 - "GET /api/telegram/groups HTTP/1.1" 500 Internal Server Error
ERROR:    Exception in ASGI application
Traceback (most recent call last):
  File "/home/runner/workspace/.pythonlibs/lib/python3.10/site-packages/uvicorn/protocols/http/httptools_impl.py", line 411, in run_asgi
    result = await app(  # type: ignore[func-returns-value]
  File "/home/runner/workspace/.pythonlibs/lib/python3.10/site-packages/uvicorn/middleware/proxy_headers.py", line 69, in __call__
    return await self.app(scope, receive, send)
  File "/home/runner/workspace/.pythonlibs/lib/python3.10/site-packages/fastapi/applications.py", line 1054, in __call__
    await super().__call__(scope, receive, send)
  File "/home/runner/workspace/.pythonlibs/lib/python3.10/site-packages/sentry_sdk/integrations/starlette.py", line 409, in _sentry_patched_asgi_app
    return await middleware(scope, receive, send)
  File "/home/runner/workspace/.pythonlibs/lib/python3.10/site-packages/sentry_sdk/integrations/asgi.py", line 174, in _run_asgi3
    return await self._run_app(scope, receive, send, asgi_version=3)
  File "/home/runner/workspace/.pythonlibs/lib/python3.10/site-packages/sentry_sdk/integrations/asgi.py", line 276, in _run_app
    raise exc from None
  File "/home/runner/workspace/.pythonlibs/lib/python3.10/site-packages/sentry_sdk/integrations/asgi.py", line 271, in _run_app
    return await self.app(
  File "/home/runner/workspace/.pythonlibs/lib/python3.10/site-packages/starlette/applications.py", line 112, in __call__
    await self.middleware_stack(scope, receive, send)
  File "/home/runner/workspace/.pythonlibs/lib/python3.10/site-packages/sentry_sdk/integrations/starlette.py", line 200, in _create_span_call
    return await old_call(app, scope, new_receive, new_send, **kwargs)
  File "/home/runner/workspace/.pythonlibs/lib/python3.10/site-packages/starlette/middleware/errors.py", line 187, in __call__
    raise exc
  File "/home/runner/workspace/.pythonlibs/lib/python3.10/site-packages/starlette/middleware/errors.py", line 165, in __call__
    await self.app(scope, receive, _send)
  File "/home/runner/workspace/.pythonlibs/lib/python3.10/site-packages/sentry_sdk/integrations/starlette.py", line 200, in _create_span_call
    return await old_call(app, scope, new_receive, new_send, **kwargs)
  File "/home/runner/workspace/.pythonlibs/lib/python3.10/site-packages/starlette/middleware/base.py", line 176, in __call__
    with recv_stream, send_stream, collapse_excgroups():
  File "/nix/store/jyvjawqnhnqhwrsinpvx1av7q2p2fcym-python3-3.10.18/lib/python3.10/contextlib.py", line 153, in __exit__
    self.gen.throw(typ, value, traceback)
  File "/home/runner/workspace/.pythonlibs/lib/python3.10/site-packages/starlette/_utils.py", line 82, in collapse_excgroups
    raise exc
  File "/home/runner/workspace/.pythonlibs/lib/python3.10/site-packages/starlette/middleware/base.py", line 178, in __call__
    response = await self.dispatch_func(request, call_next)
  File "/home/runner/workspace/server/app/core/middlewares.py", line 30, in dispatch
    response = await call_next(request)
  File "/home/runner/workspace/.pythonlibs/lib/python3.10/site-packages/starlette/middleware/base.py", line 156, in call_next
    raise app_exc
  File "/home/runner/workspace/.pythonlibs/lib/python3.10/site-packages/starlette/middleware/base.py", line 141, in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
  File "/home/runner/workspace/.pythonlibs/lib/python3.10/site-packages/sentry_sdk/integrations/starlette.py", line 200, in _create_span_call
    return await old_call(app, scope, new_receive, new_send, **kwargs)
  File "/home/runner/workspace/.pythonlibs/lib/python3.10/site-packages/starlette/middleware/base.py", line 176, in __call__
    with recv_stream, send_stream, collapse_excgroups():
  File "/nix/store/jyvjawqnhnqhwrsinpvx1av7q2p2fcym-python3-3.10.18/lib/python3.10/contextlib.py", line 153, in __exit__
    self.gen.throw(typ, value, traceback)
  File "/home/runner/workspace/.pythonlibs/lib/python3.10/site-packages/starlette/_utils.py", line 82, in collapse_excgroups
    raise exc
  File "/home/runner/workspace/.pythonlibs/lib/python3.10/site-packages/starlette/middleware/base.py", line 178, in __call__
    response = await self.dispatch_func(request, call_next)
  File "/home/runner/workspace/server/app/core/middlewares.py", line 136, in dispatch
    response = await call_next(request)
  File "/home/runner/workspace/.pythonlibs/lib/python3.10/site-packages/starlette/middleware/base.py", line 156, in call_next
    raise app_exc
  File "/home/runner/workspace/.pythonlibs/lib/python3.10/site-packages/starlette/middleware/base.py", line 141, in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
  File "/home/runner/workspace/.pythonlibs/lib/python3.10/site-packages/sentry_sdk/integrations/starlette.py", line 200, in _create_span_call
    return await old_call(app, scope, new_receive, new_send, **kwargs)
  File "/home/runner/workspace/.pythonlibs/lib/python3.10/site-packages/starlette/middleware/base.py", line 176, in __call__
    with recv_stream, send_stream, collapse_excgroups():
  File "/nix/store/jyvjawqnhnqhwrsinpvx1av7q2p2fcym-python3-3.10.18/lib/python3.10/contextlib.py", line 153, in __exit__
    self.gen.throw(typ, value, traceback)
  File "/home/runner/workspace/.pythonlibs/lib/python3.10/site-packages/starlette/_utils.py", line 82, in collapse_excgroups
    raise exc
  File "/home/runner/workspace/.pythonlibs/lib/python3.10/site-packages/starlette/middleware/base.py", line 178, in __call__
    response = await self.dispatch_func(request, call_next)
  File "/home/runner/workspace/server/app/core/middlewares.py", line 114, in dispatch
    return await call_next(request)
  File "/home/runner/workspace/.pythonlibs/lib/python3.10/site-packages/starlette/middleware/base.py", line 156, in call_next
    raise app_exc
  File "/home/runner/workspace/.pythonlibs/lib/python3.10/site-packages/starlette/middleware/base.py", line 141, in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
  File "/home/runner/workspace/.pythonlibs/lib/python3.10/site-packages/sentry_sdk/integrations/starlette.py", line 200, in _create_span_call
    return await old_call(app, scope, new_receive, new_send, **kwargs)
  File "/home/runner/workspace/.pythonlibs/lib/python3.10/site-packages/starlette/middleware/cors.py", line 85, in __call__
    await self.app(scope, receive, send)
  File "/home/runner/workspace/.pythonlibs/lib/python3.10/site-packages/sentry_sdk/integrations/starlette.py", line 298, in _sentry_exceptionmiddleware_call
    await old_call(self, scope, receive, send)
  File "/home/runner/workspace/.pythonlibs/lib/python3.10/site-packages/sentry_sdk/integrations/starlette.py", line 200, in _create_span_call
    return await old_call(app, scope, new_receive, new_send, **kwargs)
  File "/home/runner/workspace/.pythonlibs/lib/python3.10/site-packages/starlette/middleware/exceptions.py", line 62, in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
  File "/home/runner/workspace/.pythonlibs/lib/python3.10/site-packages/starlette/_exception_handler.py", line 53, in wrapped_app
    raise exc
  File "/home/runner/workspace/.pythonlibs/lib/python3.10/site-packages/starlette/_exception_handler.py", line 42, in wrapped_app
    await app(scope, receive, sender)
  File "/home/runner/workspace/.pythonlibs/lib/python3.10/site-packages/starlette/routing.py", line 714, in __call__
    await self.middleware_stack(scope, receive, send)
  File "/home/runner/workspace/.pythonlibs/lib/python3.10/site-packages/starlette/routing.py", line 734, in app
    await route.handle(scope, receive, send)
  File "/home/runner/workspace/.pythonlibs/lib/python3.10/site-packages/starlette/routing.py", line 288, in handle
    await self.app(scope, receive, send)
  File "/home/runner/workspace/.pythonlibs/lib/python3.10/site-packages/starlette/routing.py", line 76, in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
  File "/home/runner/workspace/.pythonlibs/lib/python3.10/site-packages/starlette/_exception_handler.py", line 53, in wrapped_app
    raise exc
  File "/home/runner/workspace/.pythonlibs/lib/python3.10/site-packages/starlette/_exception_handler.py", line 42, in wrapped_app
    await app(scope, receive, sender)
  File "/home/runner/workspace/.pythonlibs/lib/python3.10/site-packages/starlette/routing.py", line 73, in app
    response = await f(request)
  File "/home/runner/workspace/.pythonlibs/lib/python3.10/site-packages/sentry_sdk/integrations/fastapi.py", line 143, in _sentry_app
    return await old_app(*args, **kwargs)
  File "/home/runner/workspace/.pythonlibs/lib/python3.10/site-packages/fastapi/routing.py", line 301, in app
    raw_response = await run_endpoint_function(
  File "/home/runner/workspace/.pythonlibs/lib/python3.10/site-packages/fastapi/routing.py", line 212, in run_endpoint_function
    return await dependant.call(**values)
  File "/home/runner/workspace/server/app/routes/groups.py", line 36, in get_groups
    groups = await get_user_groups(request)
  File "/home/runner/workspace/server/app/utils/controller_helpers.py", line 163, in wrapper
    result = await func(*args, **kwargs)
  File "/home/runner/workspace/server/app/controllers/groups.py", line 39, in get_user_groups
    client = await ensure_client_connected(request)
  File "/home/runner/workspace/server/app/utils/controller_helpers.py", line 31, in ensure_client_connected
    client = await client_manager.get_user_client(user_id)
  File "/home/runner/workspace/server/app/services/telegram.py", line 338, in get_user_client
    return await self.initialize_user_client(user_id)
  File "/home/runner/workspace/server/app/services/telegram.py", line 286, in initialize_user_client
    raise e  # Re-raise if we were already trying file-based
  File "/home/runner/workspace/server/app/services/telegram.py", line 250, in initialize_user_client
    logger.info(f"Telegram client initialized with file-based session for user {user_id}: {user_session_path}")
UnboundLocalError: local variable 'user_session_path' referenced before assignment
2025-09-21 15:56:35 | INFO     | server.app.services.telegram:initialize_user_client:212 - Initializing Telegram client with StringSession/file-based session for user 1
2025-09-21 15:56:35,009 - telethon.network.mtprotosender - INFO - Connecting to 149.154.175.55:443/TcpFull...
2025-09-21 15:56:35 | INFO     | server.app.services.telegram:initialize_user_client:242 - Using transferred StringSession for user 1
2025-09-21 15:56:35,028 - telethon.network.mtprotosender - INFO - Connection to 149.154.175.55:443/TcpFull complete!
2025-09-21 15:56:35 | ERROR    | server.app.services.telegram:initialize_user_client:270 - Failed to initialize Telegram client for user 1: local variable 'user_session_path' referenced before assignment
2025-09-21 15:56:35 | ERROR    | server.app.services.monitor:_run_health_check:499 - Error in health check: local variable 'user_session_path' referenced before assignment